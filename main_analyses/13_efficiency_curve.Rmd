---
title: "13_efficiency_curve"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_depth: 1
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
---

```{r}
library(raster)
library(sf)
library(tidyverse)
library(patchwork)
library(parallel)
library(foreach)
library(doParallel)

source(here::here("common.R"))

#variant_name <- "13_efficiency_curve"

#variant_dir <- file.path(emLab_project_dir, "data", "03_output", variant_name)

#dir.create(variant_dir)

options(scipen = 999)
```

# Define preferences

This represent how important is biodiversity relative to fisheries. A value of 2 means biodiversity is 2x more important than food. A value of 0.1 means food is 10 times as valuable as biodiversity. A negative value of -1 means that biodiversity is a valuable as provision but is negatively weighted. 

```{r}
x_bios <- c(seq(-100, -10, by = 10),
            seq(-9, -1, by = 1),
            seq(-0.9, 0, by = .1),
            seq(0.01, 0.1, by = .01),
            seq(0.11, 1, by = 0.1),
            seq(2, 10, by = 1), seq(20, 100, by = 10), seq(200, 1000, by = 100), 10000)

length(unique(x_bios))
```

# No effort displacement

## Load features data 

```{r}
# source(here::here("functions", "food_provision_foos.R"))
# 
# load(file.path(emLab_project_dir, "data", "03_output", "11_multiple_objectives", "ranking_inputs.RData"))
# 
# save(bio_feature_names, bio_weights, carbon_weights, food_weights, max_bio_delta, max_carbon_delta,
#      Norm_features_matrix, protected_cells, stocks_info, stock_names, estimate_multiobjective_slopes, 
#      calculate_multiobjective_weights, max_food_delta_a1, max_food_delta_a2, MPAs_df,
#      carbon_remains_BAU, bio_remains_BAU, group_ids, fraction_in_MPA, MPAs,
#      file = file.path("13_efficiency_curve/ranking_inputs.RData"))
```

## Ranking 

```{r}
registerDoParallel(38)

run_efficiency_curve <- function(effort_assumption, bio_preferences){
  
  foreach(i = bio_preferences)%dopar%{
    
    source(here::here("functions", "food_provision_foos.R"))
    
    load(file.path("13_efficiency_curve/ranking_inputs.RData"))
    
    unprotected_matrix <- Norm_features_matrix[!protected_cells, ]
    
    protected_matrix <- Norm_features_matrix[protected_cells, ]
    
    baseline_state <- protected_cells%*%Norm_features_matrix
    
    baseline_state[,"carbon"] <- baseline_state[, "carbon"] + carbon_remains_BAU
    
    baseline_state[, bio_feature_names] <- baseline_state[, bio_feature_names] + bio_remains_BAU
    
    max_slopes_bio <- 0.25*baseline_state[, bio_feature_names]^(0.25 - 1)
    
    max_slope_carbon <- 1
    
    names(max_slope_carbon) <- "carbon"
    
    if(i > 0){
      
      w_bio = 1/(1/i + 1)
      w_carbon = 0
      w_food =  1 - w_bio
      
    } else if (i <= 0){
      
      w_food = 1
      w_carbon = 0
      w_bio = i
      
    }
    
    multiobjective_feature_weigths <- calculate_multiobjective_weights(alpha_b = w_bio, alpha_c = w_carbon, alpha_f = w_food,
                                                                       b_wts = bio_weights, c_wts = carbon_weights, f_wts = food_weights, 
                                                                       max_b = max_bio_delta, max_c = max_carbon_delta, max_f_a1  = max_food_delta_a1,
                                                                       max_f_a2  = max_food_delta_a2, effort_assumption = effort_assumption)
    
    ranking <- list()
    
    current_pick <- 0
    
    current_state <- baseline_state 
    
    while(nrow(unprotected_matrix) > 0){
      
      current_pick <- sum(current_pick, 1)
      
      slopes <- estimate_multiobjective_slopes(x = current_state, feature_group = group_ids, feature_wts  = multiobjective_feature_weigths,
                                               max_slopes_b = max_slopes_bio, max_slopes_c = max_slope_carbon, e = stocks_info$ex_rate,
                                               m = stocks_info$m, k = stocks_info$k, r = stocks_info$r, effort_assumption = effort_assumption)
      
      delta <- unprotected_matrix%*%as.matrix(slopes)
      
      best_cell_indeces <- doBy::which.maxn(delta, n = 100)
      
      best_cells <- delta[best_cell_indeces,] %>% 
        enframe() %>% 
        set_names(c('cell_id', "delta")) %>% 
        mutate(pick_order = current_pick)
      
      ranking <- bind_rows(ranking, best_cells)
      
      current_state <- unprotected_matrix[best_cell_indeces, ] %>% 
        colSums() +
        current_state
      
      unprotected_matrix <- unprotected_matrix[-best_cell_indeces, ]
      
    }
    
    write_rds(ranking, 
              here::here("main_analyses", "13_efficiency_curve", paste0("ranking_a", as.character(effort_assumption), "_", as.character(i), ".rds")))
  }
}

efficiency_rankings_a1 <- tryCatch(run_efficiency_curve(effort_assumption = 1, bio_preferences = x_bios), error = function(e) print(e))
```


## Summarize results

```{r}
source(here::here("functions", "food_provision_foos.R"))
```

```{r}
get_full_ranking <- function(ranking_df, mpas_df, ocean_df){
  
  full_ranking <- mpas_df %>% 
    filter(!is.na(mpa)) %>% 
    select(cell_id) %>% 
    bind_rows(ranking_df) %>% 
    mutate(is_mpa = is.na(delta))  %>% 
    full_join(ocean_matrix) %>% 
    replace(is.na(.), 0) 
  
  return(full_ranking)
}

get_ranked_features_df <- function(ranking_df, features_df){
  
  ranked_features_df <- ranking_df %>% 
    left_join(features_df %>% 
                as_tibble(rownames = NA) %>% 
                rownames_to_column("cell_id")) %>% 
    replace(is.na(.), 0) 
  
    return(ranked_features_df)

}
```

```{r}
files <- list.files(here::here("main_analyses", "13_efficiency_curve"), pattern = "ranking_a", full.names = "T")

registerDoParallel(7)

get_efficiency_curve <- function(files){
  
  foreach(i = files, .combine = rbind)%dopar%{
  
  file <- i
  
  load(file.path("13_efficiency_curve/ranking_inputs.RData"))
  
  effort_assumption <- as.numeric(str_extract(str_split(tools::file_path_sans_ext(basename(file)), pattern = "_", simplify = T)[,2], '[0-9]+'))
  
  run_bio_factor <- as.numeric(str_split(tools::file_path_sans_ext(basename(file)), pattern = "_", simplify = T)[,3])

  ranking <- read_rds(file)
  
  ranked_features_df <- ranking %>% 
    get_full_ranking(mpas_df = MPAs_df, ocean_df = ocean_matrix) %>% 
    get_ranked_features_df(features_df = Norm_features_matrix)
  
  optimal_protection <-  ranked_features_df %>% 
    select(delta) %>% 
    mutate(fraction_protected = 1/n(),
           fraction_protected = cumsum(fraction_protected),
           V = cumsum(delta)) %>% 
    slice(which.max(V)) %>%  
    pull(fraction_protected)
  
  food_benefit_curve <- ranked_features_df %>% 
    select(all_of(stock_names)) %>% 
    mutate_all(.funs = cumsum) %>% 
    apply(MARGIN = 1, FUN = estimate_delta_catch, e = stocks_info$ex_rate, m = stocks_info$m,
          r = stocks_info$r, k = stocks_info$k, effort_assumption = effort_assumption) %>% 
    t() %>% 
    rowSums() %>% 
    enframe(name = NULL, value = "delta_catch") %>% 
    mutate(fraction_protected = 1/n(),
           fraction_protected =  cumsum(fraction_protected))
  
  carbon_benefit_curve <- ranked_features_df %>% 
    select(carbon) %>% 
    mutate_all(.funs = cumsum) %>% 
    sweep(MARGIN = 2, carbon_remains_BAU, `+`) %>%
    mutate_all(.funs = ~(.)) %>% 
    rowSums() %>% 
    enframe(name = NULL, value = "carbon_benefit") %>% 
    mutate(carbon_benefit = scales::rescale(carbon_benefit, c(0,1)),
           fraction_protected = 1/n(),
           fraction_protected = cumsum(fraction_protected))
  
  bio_benefit_curve <-  ranked_features_df %>% 
    select(all_of(bio_feature_names)) %>% 
    mutate_all(.funs = cumsum) %>% 
    sweep(MARGIN = 2, bio_remains_BAU, `+`) %>%
    mutate_all(.funs = ~(.)^0.25) %>% 
    as.matrix() %*% as.matrix(bio_weights) %>% 
    as_tibble() %>% 
    set_names("bio_benefit") %>% 
    mutate(bio_benefit = scales::rescale(bio_benefit, c(0,1)),
           fraction_protected = 1/n(),
           fraction_protected = cumsum(fraction_protected)) 
  
  summary <- bio_benefit_curve %>% 
    left_join(carbon_benefit_curve) %>% 
    left_join(food_benefit_curve) %>% 
    filter(fraction_protected == optimal_protection) %>% 
    mutate(bio_x_factor = run_bio_factor,
           effort_assumption = effort_assumption)
  
  return(summary)
  }
  }

start <- Sys.time()
tryCatch(efficiency_curve <- get_efficiency_curve(files = files), error = function(e) print(e))
end <- Sys.time()
end-start

write_rds(efficiency_curve, "13_efficiency_curve/efficiency_curves.rds")
```

```{r}
efficiency_curve %>% 
  arrange(bio_x_factor)
```

```{r}
efficiency_curve %>% 
  ggplot()+
  geom_point(aes(bio_benefit, delta_catch, col = effort_assumption))
```



```{r}
write_rds(summary, 
              here::here("main_analyses", "13_efficiency_curve", paste0("results_a", as.character(effort_assumption), "_", as.character(i), ".rds")))
```





