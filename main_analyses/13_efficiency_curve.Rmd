---
title: "13_efficiency_curve"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_depth: 1
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
---

```{r}
library(raster)
library(sf)
library(tidyverse)
library(patchwork)
library(parallel)
library(foreach)
library(doParallel)

source(here::here("common.R"))

variant_name <- "13_efficiency_curve"

variant_dir <- file.path(emLab_project_dir, "data", "03_output", variant_name)

dir.create(variant_dir)

options(scipen = 999)
```

# Define preferences

This represent how important is biodiversity relative to fisheries. A value of 2 means biodiversity is 2x more important than food. A value of 0.1 means food is 10 times as valuable as biodiversity. A negative value of -1 means that biodiversity is a valuable as provision but is negatively weighted. 

```{r}
x_bios <- c(-10000,
            seq(-1000, -100, by = 100), 
            seq(-90, 0, by = 10),
            seq(0.1, 1, by = 0.1),
            seq(2, 10, by = 1), seq(20, 100, by = 10), seq(200, 1000, by = 100), seq(2000, 10000, by = 1000), seq(20000, 100000, by = 10000))
```

# No effort displacement

## Load features data 

```{r}
start <- Sys.time()
load(file.path(emLab_project_dir, "data", "03_output", "11_multiple_objectives", "ranking_inputs.RData"))
end <- Sys.time()
end-start
```

## Initial conditions

```{r}
unprotected_matrix <- Norm_features_matrix[!protected_cells, ]

protected_matrix <- Norm_features_matrix[protected_cells, ]

baseline_state <- protected_cells%*%Norm_features_matrix

baseline_state[,"carbon"] <- baseline_state[, "carbon"] + carbon_remains_BAU

baseline_state[, bio_feature_names] <- baseline_state[, bio_feature_names] + bio_remains_BAU

max_slopes_bio <- z_bio*baseline_state[, bio_feature_names]^(z_bio - 1)

max_slope_carbon <- 1

names(max_slope_carbon) <- "carbon"
```

## Ranking

```{r}
gc()

registerDoParallel(cores = 15)

foreach(i = x_bios)%dopar%{
  
  if(i > 0){
    
    w_bio = 1/(1/i + 1)  
    
    w_food <- 1 - w_bio
    
  } else if (i < 0){
    
    w_food = 1
    
    w_bio = i
    
  }
  
  feature_weigths <- calculate_weights(w_carbon = 0, w_food = w_food, w_bio = w_bio, food_model = "a1")
  
  ranking <- list()
  
  current_pick <- 0
  
  current_state <- baseline_state 
  
  while(nrow(unprotected_matrix) > 0){
    
    current_pick <- sum(current_pick, 1)
    
    slopes <- estimate_current_slopes(x = current_state, g = group_ids, wts = feature_weigths, food_model = "a1")
    
    delta <- unprotected_matrix%*%as.matrix(slopes)
    
    best_cell_indeces <- doBy::which.maxn(delta, n = 1000)
    
    best_cells <- delta[best_cell_indeces,] %>% 
      enframe() %>% 
      set_names(c('cell_id', "delta")) %>% 
      mutate(pick_order = current_pick)
    
    ranking <- bind_rows(ranking, best_cells)
    
    current_state <- unprotected_matrix[best_cell_indeces, , drop = F] %>% 
      colSums() +
      current_state
    
    unprotected_matrix <- unprotected_matrix[-best_cell_indeces, , drop = F]
    
  }
  
  results <- MPAs_df %>% 
    filter(!is.na(mpa)) %>% 
    select(cell_id) %>% 
    bind_rows(ranking) %>% 
    mutate(is_mpa = is.na(delta))  %>% 
    full_join(ocean_matrix) %>% 
    left_join(Norm_features_matrix %>% 
                as_tibble(rownames = NA) %>% 
                rownames_to_column("cell_id")) %>% 
    replace(is.na(.), 0)
  
  optimal_protection <- results %>% 
    mutate(fraction_protected = 1/n(),
           fraction_protected = cumsum(fraction_protected),
           V = cumsum(delta)) %>% 
    slice(which.max(V)) %>%  
    pull(fraction_protected)
  
  carbon_benefit_curve <- results %>% 
    select(carbon) %>% 
    mutate_all(.funs = cumsum) %>% 
    sweep(MARGIN = 2, carbon_remains_BAU, `+`) %>%
    mutate_all(.funs = ~(.)^z_carbon) %>% 
    as.matrix() %*% as.matrix(carbon_weights) %>% 
    as_tibble() %>% 
    set_names("V") %>% 
    mutate(fraction_protected = 1/n(),
           fraction_protected = cumsum(fraction_protected)) %>% 
    mutate(V = V - sum(carbon_remains_BAU^z_carbon*carbon_weights),
           V_norm = V/max(V))
  
  food_benefit_curve <- results %>% 
    select(all_of(stock_names)) %>% 
    mutate_all(.funs = cumsum) %>% 
    apply(MARGIN = 1, estimate_delta_catch_a1) %>% 
    t() %>% 
    as.matrix() %*% as.matrix(food_weights) %>% 
    as_tibble() %>% 
    rowSums() %>% 
    enframe(name = NULL) %>% 
    set_names("V") %>% 
    mutate(V_norm = V/max(V),
           fraction_protected = 1/n(),
           fraction_protected =  cumsum(fraction_protected)) 
  
  bio_benefit_curve <- results %>% 
    select(all_of(bio_feature_names)) %>% 
    mutate_all(.funs = cumsum) %>% 
    sweep(MARGIN = 2, bio_remains_BAU, `+`) %>%
    mutate_all(.funs = ~(.)^z_bio) %>% 
    as.matrix() %*% as.matrix(bio_weights) %>% 
    as_tibble() %>% 
    set_names("V") %>% 
    mutate(fraction_protected = 1/n(),
           fraction_protected = cumsum(fraction_protected)) %>% 
    mutate(V = V - sum(bio_remains_BAU^z_bio*bio_weights),
           V_norm = V/max(V))
  
  summary <- tibble(alpha_bio = i,
                    optim_protection = optimal_fraction_protected,
                    bio_benefit = bio_benefit_curve$V_norm[bio_benefit_curve$fraction_protected == optimal_fraction_protected],
                    carbon_benefit = carbon_benefit_curve$V_norm[carbon_benefit_curve$fraction_protected == optimal_fraction_protected],
                    delta_catch = food_benefit_curve$V_norm[food_benefit_curve$fraction_protected == optimal_fraction_protected])
  
  
  write_rds(ranking, 
            file.path(variant_dir, "runs_a1", paste0("ranking_", as.character(i), "_xbio.rds")))
  
  write_rds(summary, 
            file.path(variant_dir, "runs_a1", paste0("summary_", as.character(i), "_xbio.rds")))
}
```


# Full effort displacement

## Load features data 

```{r}
load(file.path(emLab_project_dir, "data", "03_output", "11_multiple_objectives", "ranking_inputs.RData"))
```

## Initial conditions

```{r}
unprotected_matrix <- Norm_features_matrix[!protected_cells, ]

protected_matrix <- Norm_features_matrix[protected_cells, ]

baseline_state <- protected_cells%*%Norm_features_matrix

baseline_state[,"carbon"] <- baseline_state[, "carbon"] + carbon_remains_BAU

baseline_state[, bio_feature_names] <- baseline_state[, bio_feature_names] + bio_remains_BAU

max_slopes_bio <- z_bio*baseline_state[, bio_feature_names]^(z_bio - 1)

max_slope_carbon <- 1

names(max_slope_carbon) <- "carbon"
```

## Ranking

```{r}
gc()

registerDoParallel(cores = 150)

foreach(i = x_bios)%dopar%{
  
  if(i > 0){
    
    w_bio = 1/(1/i + 1)  
    
    w_food <- 1 - w_bio
    
  } else if (i < 0){
    
    w_food = 1
    
    w_bio = i
    
  }
  
  feature_weigths <- calculate_weights(w_carbon = 0, w_food = w_food, w_bio = w_bio, food_model = "a2")
  
  ranking <- list()
  
  current_pick <- 0
  
  current_state <- baseline_state 
  
  while(nrow(unprotected_matrix) > 0){
    
    current_pick <- sum(current_pick, 1)
    
    slopes <- estimate_current_slopes(x = current_state, g = group_ids, wts = feature_weigths, food_model = "a2")
    
    delta <- unprotected_matrix%*%as.matrix(slopes)
    
    best_cell_indeces <- doBy::which.maxn(delta, n = 1000)
    
    best_cells <- delta[best_cell_indeces,] %>% 
      enframe() %>% 
      set_names(c('cell_id', "delta")) %>% 
      mutate(pick_order = current_pick)
    
    ranking <- bind_rows(ranking, best_cells)
    
    current_state <- unprotected_matrix[best_cell_indeces, , drop = F] %>% 
      colSums() +
      current_state
    
    unprotected_matrix <- unprotected_matrix[-best_cell_indeces, , drop = F]
    
  }
  
  results <- MPAs_df %>% 
    filter(!is.na(mpa)) %>% 
    select(cell_id) %>% 
    bind_rows(ranking) %>% 
    mutate(is_mpa = is.na(delta))  %>% 
    full_join(ocean_matrix) %>% 
    left_join(Norm_features_matrix %>% 
                as_tibble(rownames = NA) %>% 
                rownames_to_column("cell_id")) %>% 
    replace(is.na(.), 0)
  
  optimal_protection <- results %>% 
    mutate(fraction_protected = 1/n(),
           fraction_protected = cumsum(fraction_protected),
           V = cumsum(delta)) %>% 
    slice(which.max(V)) %>%  
    pull(fraction_protected)
  
  carbon_benefit_curve <- results %>% 
    select(carbon) %>% 
    mutate_all(.funs = cumsum) %>% 
    sweep(MARGIN = 2, carbon_remains_BAU, `+`) %>%
    mutate_all(.funs = ~(.)^z_carbon) %>% 
    as.matrix() %*% as.matrix(carbon_weights) %>% 
    as_tibble() %>% 
    set_names("V") %>% 
    mutate(fraction_protected = 1/n(),
           fraction_protected = cumsum(fraction_protected)) %>% 
    mutate(V = V - sum(carbon_remains_BAU^z_carbon*carbon_weights),
           V_norm = V/max(V))
  
  food_benefit_curve <- results %>% 
    select(all_of(stock_names)) %>% 
    mutate_all(.funs = cumsum) %>% 
    apply(MARGIN = 1, estimate_delta_catch_a1) %>% 
    t() %>% 
    as.matrix() %*% as.matrix(food_weights) %>% 
    as_tibble() %>% 
    rowSums() %>% 
    enframe(name = NULL) %>% 
    set_names("V") %>% 
    mutate(V_norm = V/max(V),
           fraction_protected = 1/n(),
           fraction_protected =  cumsum(fraction_protected)) 
  
  bio_benefit_curve <- results %>% 
    select(all_of(bio_feature_names)) %>% 
    mutate_all(.funs = cumsum) %>% 
    sweep(MARGIN = 2, bio_remains_BAU, `+`) %>%
    mutate_all(.funs = ~(.)^z_bio) %>% 
    as.matrix() %*% as.matrix(bio_weights) %>% 
    as_tibble() %>% 
    set_names("V") %>% 
    mutate(fraction_protected = 1/n(),
           fraction_protected = cumsum(fraction_protected)) %>% 
    mutate(V = V - sum(bio_remains_BAU^z_bio*bio_weights),
           V_norm = V/max(V))
  
  summary <- tibble(alpha_bio = i,
                    optim_protection = optimal_fraction_protected,
                    bio_benefit = bio_benefit_curve$V_norm[bio_benefit_curve$fraction_protected == optimal_fraction_protected],
                    carbon_benefit = carbon_benefit_curve$V_norm[carbon_benefit_curve$fraction_protected == optimal_fraction_protected],
                    delta_catch = food_benefit_curve$V_norm[food_benefit_curve$fraction_protected == optimal_fraction_protected])
  
  
  write_rds(ranking, 
            file.path(variant_dir, "runs_a2", paste0("ranking_", as.character(i), "_xbio.rds")))
  
  write_rds(summary, 
            file.path(variant_dir, "runs_a2", paste0("summary_", as.character(i), "_xbio.rds")))
}
```
